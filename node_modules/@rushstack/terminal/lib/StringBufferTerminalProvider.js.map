{"version":3,"file":"StringBufferTerminalProvider.js","sourceRoot":"","sources":["../src/StringBufferTerminalProvider.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport { StringBuilder, Text } from '@rushstack/node-core-library';\n\nimport { type ITerminalProvider, TerminalProviderSeverity } from './ITerminalProvider';\nimport { AnsiEscape } from './AnsiEscape';\n\n/**\n * @beta\n */\nexport interface IStringBufferOutputOptions {\n  /**\n   * If set to true, special characters like \\\\n, \\\\r, and the \\\\u001b character\n   * in color control tokens will get normalized to [-n-], [-r-], and [-x-] respectively\n   *\n   * This option defaults to `true`\n   */\n  normalizeSpecialCharacters?: boolean;\n}\n\n/**\n * @beta\n */\nexport interface IStringBufferOutputChunksOptions extends IStringBufferOutputOptions {\n  /**\n   * If true, the output will be returned as an array of lines prefixed with severity tokens.\n   */\n  asLines?: boolean;\n}\n\n/**\n * @beta\n */\nexport interface IAllStringBufferOutput {\n  log: string;\n  warning: string;\n  error: string;\n  verbose: string;\n  debug: string;\n}\n\n/**\n * @beta\n */\nexport type TerminalProviderSeverityName = keyof typeof TerminalProviderSeverity;\n\n/**\n * @beta\n */\nexport interface IOutputChunk {\n  text: string;\n  severity: TerminalProviderSeverityName;\n}\n\nfunction _normalizeOptions<TOptions extends IStringBufferOutputOptions>(\n  options: TOptions\n): TOptions & Required<IStringBufferOutputOptions> {\n  return {\n    normalizeSpecialCharacters: true,\n    ...options\n  };\n}\n\nfunction _normalizeOutput(s: string, options: IStringBufferOutputOptions | undefined): string {\n  const { normalizeSpecialCharacters } = _normalizeOptions(options ?? {});\n  return _normalizeOutputInner(s, normalizeSpecialCharacters);\n}\n\nfunction _normalizeOutputInner(s: string, normalizeSpecialCharacters: boolean): string {\n  s = Text.convertToLf(s);\n\n  if (normalizeSpecialCharacters) {\n    return AnsiEscape.formatForTests(s, { encodeNewlines: true });\n  } else {\n    return s;\n  }\n}\n\nconst LONGEST_SEVERITY_NAME_LENGTH: number = Object.keys(TerminalProviderSeverity).reduce(\n  (max: number, k: string) => Math.max(max, k.length),\n  0\n);\n\n/**\n * Terminal provider that stores written data in buffers separated by severity.\n * This terminal provider is designed to be used when code that prints to a terminal\n * is being unit tested.\n *\n * @beta\n */\nexport class StringBufferTerminalProvider implements ITerminalProvider {\n  private _standardBuffer: StringBuilder = new StringBuilder();\n  private _verboseBuffer: StringBuilder = new StringBuilder();\n  private _debugBuffer: StringBuilder = new StringBuilder();\n  private _warningBuffer: StringBuilder = new StringBuilder();\n  private _errorBuffer: StringBuilder = new StringBuilder();\n  private _allOutputChunks: IOutputChunk[] = [];\n\n  /**\n   * {@inheritDoc ITerminalProvider.supportsColor}\n   */\n  public readonly supportsColor: boolean;\n\n  public constructor(supportsColor: boolean = false) {\n    this.supportsColor = supportsColor;\n  }\n\n  /**\n   * {@inheritDoc ITerminalProvider.write}\n   */\n  public write(text: string, severity: TerminalProviderSeverity): void {\n    const severityName: TerminalProviderSeverityName = TerminalProviderSeverity[\n      severity\n    ] as TerminalProviderSeverityName;\n\n    const lastChunk: IOutputChunk | undefined = this._allOutputChunks[this._allOutputChunks.length - 1];\n    if (lastChunk && lastChunk.severity === severityName) {\n      lastChunk.text += text;\n    } else {\n      this._allOutputChunks.push({\n        text,\n        severity: severityName\n      });\n    }\n\n    switch (severity) {\n      case TerminalProviderSeverity.warning: {\n        this._warningBuffer.append(text);\n        break;\n      }\n\n      case TerminalProviderSeverity.error: {\n        this._errorBuffer.append(text);\n        break;\n      }\n\n      case TerminalProviderSeverity.verbose: {\n        this._verboseBuffer.append(text);\n        break;\n      }\n\n      case TerminalProviderSeverity.debug: {\n        this._debugBuffer.append(text);\n        break;\n      }\n\n      case TerminalProviderSeverity.log:\n      default: {\n        this._standardBuffer.append(text);\n        break;\n      }\n    }\n  }\n\n  /**\n   * {@inheritDoc ITerminalProvider.eolCharacter}\n   */\n  public get eolCharacter(): string {\n    return '\\n';\n  }\n\n  /**\n   * Get everything that has been written at log-level severity.\n   */\n  public getOutput(options?: IStringBufferOutputOptions): string {\n    return _normalizeOutput(this._standardBuffer.toString(), options);\n  }\n\n  /**\n   * @deprecated - use {@link StringBufferTerminalProvider.getVerboseOutput}\n   */\n  public getVerbose(options?: IStringBufferOutputOptions): string {\n    return this.getVerboseOutput(options);\n  }\n\n  /**\n   * Get everything that has been written at verbose-level severity.\n   */\n  public getVerboseOutput(options?: IStringBufferOutputOptions): string {\n    return _normalizeOutput(this._verboseBuffer.toString(), options);\n  }\n\n  /**\n   * Get everything that has been written at debug-level severity.\n   */\n  public getDebugOutput(options?: IStringBufferOutputOptions): string {\n    return _normalizeOutput(this._debugBuffer.toString(), options);\n  }\n\n  /**\n   * Get everything that has been written at error-level severity.\n   */\n  public getErrorOutput(options?: IStringBufferOutputOptions): string {\n    return _normalizeOutput(this._errorBuffer.toString(), options);\n  }\n\n  /**\n   * Get everything that has been written at warning-level severity.\n   */\n  public getWarningOutput(options?: IStringBufferOutputOptions): string {\n    return _normalizeOutput(this._warningBuffer.toString(), options);\n  }\n\n  /**\n   * Get everything that has been written at all severity levels.\n   */\n  public getAllOutput(sparse?: false, options?: IStringBufferOutputOptions): IAllStringBufferOutput;\n  public getAllOutput(sparse: true, options?: IStringBufferOutputOptions): Partial<IAllStringBufferOutput>;\n  public getAllOutput(\n    sparse: boolean | undefined,\n    options?: IStringBufferOutputOptions\n  ): Partial<IAllStringBufferOutput> {\n    const result: Partial<IAllStringBufferOutput> = {};\n\n    const log: string = this.getOutput(options);\n    if (!sparse || log) {\n      result.log = log;\n    }\n\n    const warning: string = this.getWarningOutput(options);\n    if (!sparse || warning) {\n      result.warning = warning;\n    }\n\n    const error: string = this.getErrorOutput(options);\n    if (!sparse || error) {\n      result.error = error;\n    }\n\n    const verbose: string = this.getVerboseOutput(options);\n    if (!sparse || verbose) {\n      result.verbose = verbose;\n    }\n\n    const debug: string = this.getDebugOutput(options);\n    if (!sparse || debug) {\n      result.debug = debug;\n    }\n\n    return result;\n  }\n\n  /**\n   * Get everything that has been written as an array of output chunks, preserving order.\n   */\n  public getAllOutputAsChunks(\n    options?: IStringBufferOutputChunksOptions & { asLines?: false }\n  ): IOutputChunk[];\n  public getAllOutputAsChunks(\n    options: IStringBufferOutputChunksOptions & { asLines: true }\n  ): `[${string}] ${string}`[];\n  public getAllOutputAsChunks(options: IStringBufferOutputChunksOptions = {}): IOutputChunk[] | string[] {\n    const { asLines, normalizeSpecialCharacters } = _normalizeOptions(options);\n    if (asLines) {\n      const lines: `[${string}] ${string}`[] = [];\n\n      for (const { text: rawText, severity: rawSeverity } of this._allOutputChunks) {\n        const severity: string = (rawSeverity as TerminalProviderSeverityName).padStart(\n          LONGEST_SEVERITY_NAME_LENGTH,\n          ' '\n        );\n\n        const lfText: string = Text.convertToLf(rawText);\n        const rawLines: string[] = lfText.split('\\n');\n\n        // Emit one entry per logical line.\n        for (let i: number = 0; i < rawLines.length; i++) {\n          const isLast: boolean = i === rawLines.length - 1;\n          const isFinalTrailingEmpty: boolean = isLast && rawLines[i] === '';\n\n          if (isFinalTrailingEmpty) {\n            continue;\n          }\n\n          const hasNewlineAfter: boolean = i < rawLines.length - 1;\n\n          // If the original output had a newline after this line, preserve it as the special token\n          // (e.g. \"[n]\") when normalization is enabled.\n          const shouldIncludeNewlineToken: boolean = normalizeSpecialCharacters && hasNewlineAfter;\n          const lineText: string = shouldIncludeNewlineToken ? `${rawLines[i]}\\n` : rawLines[i];\n\n          const text: string = _normalizeOutputInner(lineText, normalizeSpecialCharacters);\n          lines.push(`[${severity}] ${text}`);\n        }\n      }\n\n      return lines;\n    } else {\n      return this._allOutputChunks.map(({ text: rawText, severity }) => {\n        const text: string = _normalizeOutputInner(rawText, normalizeSpecialCharacters);\n        return {\n          text,\n          severity\n        };\n      });\n    }\n  }\n}\n"]}